FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
RUN git clone --recurse-submodules https://github.com/Neko-Net-Sync/NekoNet-Server /home/mare/NekoNet-Server
WORKDIR /home/mare/NekoNet-Server
RUN dotnet publish NekoNetServer/NekoNetAuthService/NekoNetAuthService.csproj -c Release -o /NekoNetAuthService

FROM mcr.microsoft.com/dotnet/aspnet:9.0
RUN adduser --disabled-password --group --no-create-home --quiet --system mare
COPY --from=build /NekoNetAuthService /opt/NekoNetAuthService
RUN chown -R mare:mare /opt/NekoNetAuthService && \
    apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
USER mare:mare
WORKDIR /opt/NekoNetAuthService
CMD ["./NekoNetAuthService"]